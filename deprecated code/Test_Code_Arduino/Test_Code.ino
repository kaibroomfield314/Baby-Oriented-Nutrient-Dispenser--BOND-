#include <Servo.h>

const int pot_pin     = A0;  // potentiometer wiper
const int servo_pin   = 9;   // SG90 signal (yellow) on D9
const int button_pin  = 2;   // momentary push button -> GND (INPUT_PULLUP)
const int switch_pin  = 3;   // toggle switch -> GND (INPUT_PULLUP) for continuous mode
const int jitter_pin  = 4;   // toggle switch -> GND (INPUT_PULLUP) for jitter mode

// Servo travel limits (trim if it buzzes at the ends)
const int min_us = 500;
const int max_us = 2400;

// UP stroke speed limits (delay per step). Lower = faster.
// DOWN stroke is smooth at fixed fast speed.
const int min_step_delay_ms = 2;    // fastest up
const int max_step_delay_ms = 25;   // slowest up
const int down_step_delay_ms = 2;   // smooth fast down

bool reverse_rotation = true;       // keep software reversal

Servo sg90;

int step_delay_ms_from_pot() {
  int pot = analogRead(pot_pin); // 0..1023
  return map(pot, 0, 1023, max_step_delay_ms, min_step_delay_ms);
}

void write_angle(int angle) {
  angle = constrain(angle, 0, 180);
  sg90.write(reverse_rotation ? (180 - angle) : angle);
}

// Jitter burst clamped to [min_lim, max_lim] so it only shakes in the desired zone
void jitter_burst_range(int angle, int amp, int tick_ms, int repeats, int min_lim, int max_lim) {
  int lo = constrain(angle - amp, min_lim, max_lim);
  int hi = constrain(angle + amp, min_lim, max_lim);
  for (int i = 0; i < repeats; i++) {
    write_angle(hi); delay(tick_ms);
    write_angle(lo); delay(tick_ms);
  }
  write_angle(angle);
}

// One full cycle per your mode rules
void run_cycle() {
  bool jitter_mode = (digitalRead(jitter_pin) == LOW); // ON -> LOW

  write_angle(0);
  delay(200);

  if (!jitter_mode) {
    // --- NORMAL: smooth full up at poti speed
    for (int angle = 0; angle <= 180; angle++) {
      write_angle(angle);
      delay(step_delay_ms_from_pot());
    }
  } else {
    // --- JITTER MODE: smooth to 90, shake 90..150, smooth to 180
    // Smooth 0..90
    for (int angle = 0; angle <= 120; angle++) {
      write_angle(angle);
      delay(step_delay_ms_from_pot());
    }
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































       xz
    // Shake 90..150
    for (int angle = 121; angle <= 160; angle++) {
      write_angle(angle);
      delay(step_delay_ms_from_pot());
      jitter_burst_range(angle, /*amp*/10, /*tick*/10, /*repeats*/2, /*min*/90, /*max*/150);
    }
    // Smooth 150..180
    for (int angle = 161; angle <= 180; angle++) {
      write_angle(angle);
      delay(step_delay_ms_from_pot());
    }
  }

  delay(200); // short pause at max

  // Smooth down 180..0 (fast, no jitter)
  for (int angle = 180; angle >= 0; angle--) {
    write_angle(angle);
    delay(down_step_delay_ms);
    // If you prefer downstroke at poti speed instead, replace with:
    // delay(step_delay_ms_from_pot());
  }

  write_angle(0);
  delay(150);
}

void setup() {
  pinMode(button_pin, INPUT_PULLUP);
  pinMode(switch_pin, INPUT_PULLUP);
  pinMode(jitter_pin, INPUT_PULLUP);

  sg90.attach(servo_pin, min_us, max_us);
  write_angle(0); // park on startup
}

void loop() {
  bool continuous_mode = (digitalRead(switch_pin) == LOW); // ON -> LOW

  if (continuous_mode) {
    do {
      run_cycle();
      continuous_mode = (digitalRead(switch_pin) == LOW);
    } while (continuous_mode);

    write_angle(0);
    delay(100);
    return;
  }

  if (digitalRead(button_pin) == LOW) {
    delay(20); // debounce
    if (digitalRead(button_pin) == LOW) {
      run_cycle();
      while (digitalRead(button_pin) == LOW) delay(5); // wait release
    }
  }
  // idle
}
